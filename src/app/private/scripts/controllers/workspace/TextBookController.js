'use strict'

angular.module('playerApp')
    .controller('TextBookController', ['contentService', '$timeout', '$state', 'config',
      '$rootScope', 'toasterService', 'configService', function (contentService, $timeout, $state, config,
            $rootScope, toasterService, configService) {
        var textbook = this
        textbook.formDropdown = configService.getWorkspaceFormDropdown()
        textbook.boards = textbook.formDropdown.boards
        textbook.mediums = textbook.formDropdown.medium
        textbook.subjects = textbook.formDropdown.subjects
        textbook.grades = textbook.formDropdown.grades
        textbook.showCreateTextBookModal = false
        textbook.isTextBookCreated = false
        textbook.userId = $rootScope.userId
        textbook.mimeType = 'application/vnd.ekstep.content-collection'
        textbook.defaultName = 'Untitled textbook'
        textbook.contentType = 'TextBook'

        textbook.hideCreateTextBookModal = function () {
          $('#createTextBookModal').modal('hide')
          $('#createTextBookModal').modal('hide others')
          $('#createTextBookModal').modal('hide dimmer')
        }

        textbook.initializeModal = function () {
          textbook.showCreateTextBookModal = true
          $timeout(function () {
            $('#boardDropDown').dropdown()
            $('#mediumDropDown').dropdown()
            $('#subjectDropDown').dropdown()
            $('#gradeDropDown').dropdown()
            $('#createTextBookModal').modal({
              onHide: function () {
                textbook.data = {}
                if (!textbook.isTextBookCreated) {
                  $state.go('WorkSpace.ContentCreation')
                }
              }
            }).modal('show')
          }, 10)
        }

        textbook.createContent = function (requestData) {
          textbook.loader = toasterService.loader('', $rootScope.messages.stmsg.m0014)
          contentService.create(requestData).then(function (res) {
            if (res && res.responseCode === 'OK') {
              textbook.isTextBookCreated = true
              textbook.showCreateTextBookModal = false
              textbook.loader.showLoader = false
              textbook.hideCreateTextBookModal()
              textbook.initEKStepCE(res.result.content_id)
            } else {
              textbook.loader.showLoader = false
              toasterService.error($rootScope.messages.fmsg.m0008)
            }
          }).catch(function () {
            textbook.loader.showLoader = false
            toasterService.error($rootScope.messages.fmsg.m0008)
          })
        }

        textbook.saveMetaData = function (data) {
          var requestBody = angular.copy(data)
          requestBody.name = requestBody.name ? requestBody.name : textbook.defaultName
          requestBody.mimeType = textbook.mimeType
          requestBody.createdBy = textbook.userId
          requestBody.contentType = textbook.contentType
          if (requestBody.language) {
            requestBody.language = [requestBody.language]
          }
          var requestData = {
            content: requestBody
          }
          textbook.createContent(requestData)
        }

        textbook.initEKStepCE = function (contentId) {
          var params = { contentId: contentId, type: 'TextBook' }
          $state.go('CollectionEditor', params)
        }
      }])
